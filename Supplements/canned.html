<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alejandro Morales">
<meta name="dcterms.date" content="2025-11-25">

<title>Practical Labs CSA-40306 Ecological Modelling and Data Analysis in R â€“ Supplement: Formula-based methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Supplements/canned.html">Supplement: Formula-based methods</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Practical Labs CSA-40306 Ecological Modelling and Data Analysis in R</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab1/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 1</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab2/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 2</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab3/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 3</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab4/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 4</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab6/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 5 &amp; 6</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab7/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 7</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab9/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 9</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab10/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 10</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Supplements/optim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Supplement: mle2 vs optim</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Supplements/canned.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Supplement: Formula-based methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Supplements/bias_variance/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Supplement: Variance and bias of estimates</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Supplements/Stan/no_solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Supplement: Bayesian inference with Stan</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Solutions</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab1/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 1 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab2/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 2 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab3/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 3 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab4/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 4 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab6/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 5 &amp; 6 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab7/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 7 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab9/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 9 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Lab10/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 10 (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Supplements/bias_variance/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variance and bias of estimates (solutions)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Supplements/Stan/solution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Supplement: Bayesian inference with Stan (solutions)</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#the-formula-interface" id="toc-the-formula-interface" class="nav-link" data-scroll-target="#the-formula-interface"><span class="header-section-number">2</span> The <em>formula</em> interface</a>
  <ul class="collapse">
  <li><a href="#basic-linear-formula" id="toc-basic-linear-formula" class="nav-link" data-scroll-target="#basic-linear-formula"><span class="header-section-number">2.1</span> Basic linear formula</a></li>
  <li><a href="#random-effects" id="toc-random-effects" class="nav-link" data-scroll-target="#random-effects"><span class="header-section-number">2.2</span> Random effects</a></li>
  <li><a href="#non-linear-formulae" id="toc-non-linear-formulae" class="nav-link" data-scroll-target="#non-linear-formulae"><span class="header-section-number">2.3</span> Non-linear formulae</a></li>
  </ul></li>
  <li><a href="#overview-of-packages" id="toc-overview-of-packages" class="nav-link" data-scroll-target="#overview-of-packages"><span class="header-section-number">3</span> Overview of packages</a>
  <ul class="collapse">
  <li><a href="#stats" id="toc-stats" class="nav-link" data-scroll-target="#stats"><span class="header-section-number">3.1</span> <code>stats</code></a></li>
  <li><a href="#bbmle" id="toc-bbmle" class="nav-link" data-scroll-target="#bbmle"><span class="header-section-number">3.2</span> <code>bbmle</code></a></li>
  <li><a href="#nlme" id="toc-nlme" class="nav-link" data-scroll-target="#nlme"><span class="header-section-number">3.3</span> <code>nlme</code></a></li>
  <li><a href="#lme4" id="toc-lme4" class="nav-link" data-scroll-target="#lme4"><span class="header-section-number">3.4</span> <code>lme4</code></a></li>
  <li><a href="#glmmtmb" id="toc-glmmtmb" class="nav-link" data-scroll-target="#glmmtmb"><span class="header-section-number">3.5</span> <code>glmmTMB</code></a></li>
  <li><a href="#rstanarm" id="toc-rstanarm" class="nav-link" data-scroll-target="#rstanarm"><span class="header-section-number">3.6</span> <code>rstanarm</code></a></li>
  <li><a href="#brms" id="toc-brms" class="nav-link" data-scroll-target="#brms"><span class="header-section-number">3.7</span> <code>brms</code></a></li>
  </ul></li>
  <li><a href="#linear-responses" id="toc-linear-responses" class="nav-link" data-scroll-target="#linear-responses"><span class="header-section-number">4</span> Linear responses</a>
  <ul class="collapse">
  <li><a href="#linear-model" id="toc-linear-model" class="nav-link" data-scroll-target="#linear-model"><span class="header-section-number">4.1</span> Linear model</a></li>
  <li><a href="#generalized-least-squares" id="toc-generalized-least-squares" class="nav-link" data-scroll-target="#generalized-least-squares"><span class="header-section-number">4.2</span> Generalized least squares</a></li>
  <li><a href="#linear-mixed-model" id="toc-linear-mixed-model" class="nav-link" data-scroll-target="#linear-mixed-model"><span class="header-section-number">4.3</span> Linear mixed model</a></li>
  </ul></li>
  <li><a href="#non-linear-responses" id="toc-non-linear-responses" class="nav-link" data-scroll-target="#non-linear-responses"><span class="header-section-number">5</span> Non-linear responses</a>
  <ul class="collapse">
  <li><a href="#on-self-starting-functions" id="toc-on-self-starting-functions" class="nav-link" data-scroll-target="#on-self-starting-functions"><span class="header-section-number">5.1</span> On self-starting functions</a></li>
  <li><a href="#non-linear-model" id="toc-non-linear-model" class="nav-link" data-scroll-target="#non-linear-model"><span class="header-section-number">5.2</span> Non-linear model</a></li>
  <li><a href="#non-linear-mixed-models" id="toc-non-linear-mixed-models" class="nav-link" data-scroll-target="#non-linear-mixed-models"><span class="header-section-number">5.3</span> Non-linear mixed models</a></li>
  </ul></li>
  <li><a href="#generalized-linear-responses" id="toc-generalized-linear-responses" class="nav-link" data-scroll-target="#generalized-linear-responses"><span class="header-section-number">6</span> Generalized linear responses</a>
  <ul class="collapse">
  <li><a href="#generalized-linear-models" id="toc-generalized-linear-models" class="nav-link" data-scroll-target="#generalized-linear-models"><span class="header-section-number">6.1</span> Generalized linear models</a></li>
  <li><a href="#generalized-linear-mixed-models" id="toc-generalized-linear-mixed-models" class="nav-link" data-scroll-target="#generalized-linear-mixed-models"><span class="header-section-number">6.2</span> Generalized linear mixed models</a></li>
  </ul></li>
  <li><a href="#generalized-non-linear-responses" id="toc-generalized-non-linear-responses" class="nav-link" data-scroll-target="#generalized-non-linear-responses"><span class="header-section-number">7</span> Generalized non-linear responses</a>
  <ul class="collapse">
  <li><a href="#generalized-non-linear-models" id="toc-generalized-non-linear-models" class="nav-link" data-scroll-target="#generalized-non-linear-models"><span class="header-section-number">7.1</span> Generalized non-linear models</a></li>
  <li><a href="#generalized-non-linear-mixed-models" id="toc-generalized-non-linear-mixed-models" class="nav-link" data-scroll-target="#generalized-non-linear-mixed-models"><span class="header-section-number">7.2</span> Generalized non-linear mixed models</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Supplement: Formula-based methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alejandro Morales </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 25, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Here I exemplify several typical statistical models with an example of each. For each type of model I provide:</p>
<ol type="1">
<li>Mathematical description</li>
<li>Function implementing negative log likelihood</li>
<li>Canned method that relies on <em>formula</em></li>
</ol>
<p>There are functions that allow specifying different types of models with formulae and exist for both Maximum Likelihood and Bayesian methods. In the case of maximum likelihood methods, they often implement methods of estimation that are specialized to a given class of model and are therefore more efficient than using non-linear optimization.</p>
<p>The formulae that are used to specify models can be slightly different for each package, but there are some common elements that are useful to know and I described in the section below. For possible extensions, read the documentation of each individual package or function.</p>
<p>I list different possible options below, for each type of model, starting with the simplest (linear models) up to the most general (non-linear mixed models with non-Normal responses).</p>
</section>
<section id="the-formula-interface" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> The <em>formula</em> interface</h1>
<p>Most statistical models in R are implemented with formulae describing the relationship between the response variable of interest and the predictors (i.e., groups, covariates). These formulae are actually describing the deterministic component of the likelihood function. The stochastic component is implicit or indicated somewhere else in the modelling function.</p>
<section id="basic-linear-formula" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="basic-linear-formula"><span class="header-section-number">2.1</span> Basic linear formula</h2>
<p>The basic formulae was originally developed for linear and generalized linear models. In these models, predictors are related linearly with the mean response (in the case of linear models) or a non-linear transformation of the mean (in the case of generalized linear models). An example of a linear formula is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>y <span class="sc">~</span> a <span class="sc">+</span> b<span class="sc">*</span>c <span class="sc">+</span> <span class="fu">I</span>(c<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The response variable (that we want to explain or predict) is <code>y</code> and is always written on the left-side of <code>~</code>. The variables that we are using to predict or explain <code>y</code> are <code>a</code>, <code>b</code> and <code>c</code>. Each variable has a different effect:</p>
<ul>
<li><p><code>a</code> has a linear effect on <code>y</code>. If <code>a</code> is a continuous variable (in R, <code>numeric</code>) then <code>a</code> is related to <code>y</code> by a slope. If <code>a</code> is a categorical variable then each possible level of <code>a</code> will result in a different fixed increment (or decrease) in <code>y</code>.</p></li>
<li><p><code>b</code> and <code>c</code> has similar effects as <code>a</code> but they are also assume to be interacting. Interactions between two variables can be specified with <code>:</code> and the <code>*</code> is a shortcut for both direct effects and interactions, that is, <code>b*c = b + c + b:c</code>. An interaction means that the effect of one variable (<code>b</code>) depends on the value of another variable (<code>c</code>) and viceversa.</p></li>
<li><p>The identity function <code>I()</code> can be used to include a function of variable in the model, in this case, the square of <code>c</code>. We could also have calculated this square value as an additional column in the dataset and refer to it in the formula, so this is just a convenience.</p></li>
<li><p>In most cases, there will be an implicit intercept added to the linear model unless we add <code>0</code> or <code>-1</code> to the formula, in which case the intercept will not be included.</p></li>
<li><p>If there is an intercept present in the model, the effect of categorical variables will be encoded as follows: (i) the first level (determined by alphanumeric order or if you have a <code>factor</code> variable by the order of its <code>levels</code>) will be included in the intercept and (ii) the effect of any other level of that variable will be encoded as a difference with respect to the intercept.</p></li>
</ul>
</section>
<section id="random-effects" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="random-effects"><span class="header-section-number">2.2</span> Random effects</h2>
<p>Random effects refer to the distribution of latent variables in a hierarchical model as implemented in mixed model packaged (<code>nlme</code>, <code>mle4</code>, <code>glmmTMB</code>, <code>brms</code>). Most packages use an additive procedure as follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>y <span class="sc">~</span> a <span class="sc">+</span> b<span class="sc">*</span>c <span class="sc">+</span> <span class="fu">I</span>(c<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> a <span class="sc">|</span> Location<span class="sc">/</span>Year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The random effects are defined in brackets. Inside the brackets we write a special formula separated by a vertical bar (<code>|</code>). On the left side we specify the parameters in the model that are going to be modelled as latent random variables. Note that we refer to these parameters by the name of the predictor to which they are associated (with <code>1</code> being the special symbol for intercept). In the example above, the intercept is assume to vary randomly across different <code>Location</code> and <code>Year</code>, but also the effects of each level (or slopes) of <code>a</code>. The effects or slopes associated to <code>b</code>, <code>c</code>, <code>b:c</code> and <code>I(c^2)</code> are assumed fixed, that is, they do not vary across different <code>Location</code> and <code>Year</code>.</p>
<p>The right hand side of the <code>|</code> indicate the variables that define the groups across which the random effects are defined, in this case <code>Location</code> and <code>Year</code>. The symbol <code>/</code> indicates that these groups are nested. This refers to the fact that we vary the parameters across locations (so each location gets a random effect for the intercept and a different random effect for each level of <code>a</code>) and then, within each location, there is a second random distribution across years for each parameter. This is equivalent to having two random effects where the second refers to each combination of <code>Location</code> and <code>Year</code>. So a nested random effects is equivalent to the sum of two random effects where the second is computed for the interactions of the effects.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span> <span class="sc">+</span> a <span class="sc">|</span> Location<span class="sc">/</span>Year) <span class="ot">=</span> (<span class="dv">1</span> <span class="sc">+</span> a <span class="sc">|</span> Location) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> a <span class="sc">|</span> Location<span class="sc">:</span>Year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, the intercept of a particular <code>Location:Year</code> combination (<span class="math inline">\(\alpha_{i,j}\)</span>) would be computed as the sum of three components:</p>
<p><span class="math display">\[
\alpha_{i,j} = \alpha_p + \Delta \alpha_i + \Delta \alpha_{i,j}
\]</span></p>
<p>Where <span class="math inline">\(\alpha_p\)</span> is average intercept across all years and locations (often call a <em>population parameter</em>), <span class="math inline">\(\Delta \alpha_i\)</span> is the random effect on the intercept of a particular location and <span class="math inline">\(\Delta \alpha_{i,j}\)</span> is the random effect on the intercept of a particular year:location combination.</p>
<p>Note that implict in these formulae is that the random effects for a particular parameter and grouping variable follows a normal distribution with mean zero. As far as I known, there are no formula-based methods for mixed models where the variation of parameters across groups is non-Normal.</p>
</section>
<section id="non-linear-formulae" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="non-linear-formulae"><span class="header-section-number">2.3</span> Non-linear formulae</h2>
<p>For non-linear models, a formula may be used. In this context, the formula will be interpreted in a different way. Non-linear formula are just a description of the deterministic model that relates predictors to the mean of the response variable. To distinguish which symbols refer to parameters and which symbols refer to variables, the modelling function will use the list of initial parameter values (usually called <code>start</code>) and the data (usually called <code>data</code>) that the user provides. For example, a Michaelis-Menten relationship can be specified as:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>y <span class="sc">~</span> a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note however that there are many variants of this paradigm across different packages. For example, the <code>mle2</code> function allows specifying different distributions for non-linear models and to model all parameters. Thus, the distribution needs to be specified as part of the formula, as in:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>y <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="at">mean =</span> a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x), <span class="at">sd =</span> sigma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the <code>brms</code> package you can also specify different distributions for non-linear models but the first approach is used to model the mean and the models for other parameters are specified by separate formulae. In fact, <code>brms</code> allows implementing arbitrarily complex models by combining multiple formulae so it is the less restrictive formula-based method.</p>
</section>
</section>
<section id="overview-of-packages" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Overview of packages</h1>
<section id="stats" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="stats"><span class="header-section-number">3.1</span> <code>stats</code></h2>
<p>One of the packages that comes with R pre-installed, allows building models with only one stochastic component. The functions in introduces are:</p>
<ul>
<li><code>lm</code>: Linear models.</li>
<li><code>glm</code>: Generalized linear models.</li>
<li><code>nls</code>: Non-linear models.</li>
</ul>
</section>
<section id="bbmle" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="bbmle"><span class="header-section-number">3.2</span> <code>bbmle</code></h2>
<p>The MLE package by Benjamin Bolker, developed in parallel with the book. This package propposes the function <code>mle2</code> that replaces the <code>mle</code> function in <code>stats4</code> with similar functionality.</p>
<p>Note: Here we focus on the formula version of this function. If you implement your own negative log-likelihood function you can fit any more in this document as shown in the course.</p>
</section>
<section id="nlme" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="nlme"><span class="header-section-number">3.3</span> <code>nlme</code></h2>
<p>Package for linear and non-linear mixed effect models and generalized least squares. This is the original package developed by Pinheiro and Bates and associated to their mixed model book and has been one of the most popular packages for mixed effects models in R for a long time. The functions it introduces are:</p>
<ul>
<li><code>gls</code>: Linear models with generalized least squares.</li>
<li><code>gnls</code>: Non-linear models with generalized least squares.</li>
<li><code>mle</code>: Linear mixed effect models.</li>
<li><code>nlme</code>: Non-linear mixed effect models.</li>
</ul>
<p>The package also contains many functions for modeling the variance of the response as a function of groups and covariates (see <code>?varClasses</code>) and also the correlation structure of residuals (see <code>?corClasses</code>).</p>
</section>
<section id="lme4" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="lme4"><span class="header-section-number">3.4</span> <code>lme4</code></h2>
<p>Package for linear, generalized linear and non-linear mixed effect models. The functions it introduces are:</p>
<ul>
<li><code>lmer</code>: Linear mixed effect models.</li>
<li><code>glmer</code>: Generalized linear mixed effect models.</li>
<li><code>nlmer</code>: Non-linear mixed effect models.</li>
</ul>
<p>Unlike <code>nlme</code>, the package <code>lme4</code> does not allow modelling the varaince in the response or correlation structure of residuals.</p>
</section>
<section id="glmmtmb" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="glmmtmb"><span class="header-section-number">3.5</span> <code>glmmTMB</code></h2>
<p>Package for linear, generalized and non-linear (mixed) models. Unlike previous package, this one allows random effects as optional. This package builds on top of TMB (a package for defining likelihoods in C++). It offers a single but very versatile <code>glmmTMB</code> function that will automatically detect the correct type of model from the formula. Like <code>nlme</code> it allows modelling the correlation structure of the residuals, but not the variance or scale parameter.</p>
<p>Recently, they added the possibility of defining priors. This allows performing Maximum a Posterior Estimation (see example in Chapter 6) but also to run the model in Stan that implements Hamiltonian Monte Carlo for Bayesian inference. The system for specifying priors has been taken from the package <code>brms</code> (see below).</p>
</section>
<section id="rstanarm" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="rstanarm"><span class="header-section-number">3.6</span> <code>rstanarm</code></h2>
<p>Package for Bayesian estimation of linear and generalized linear (mixed) models. It is built on top of Stan but all the C++ code is precompiled and heavily optimized, so it is a very efficient tool for quick Bayesian modeling. The functions it offers are:</p>
<ul>
<li><code>stan_lm</code>: Linear models.</li>
<li><code>stan_glm</code>: Generalized linear models.</li>
<li><code>stan_lmer</code>: Linear mixed models as in <code>lmer</code>.</li>
<li><code>stan_glmer</code>: Generalized linear mixed models as in <code>glmer</code>.</li>
<li><code>stan_nlmer</code>: Non-linear mixed models as in <code>nlmer</code> but only works with the basic self-starting functions (see below for relevant section).</li>
</ul>
</section>
<section id="brms" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="brms"><span class="header-section-number">3.7</span> <code>brms</code></h2>
<p>Package for Bayesian estimate that covers all the types of models described in this document. It is built on top of Stan but unlike <code>rstanarm</code>, it will generate ad-hoc Stan code based on the model formulated by the user. This means that the user will have to pay the cost of compiling the model (which can often exceed the time it takes to generate the samples) but this brings an enormous flexibility to the user. The only limitation (like all other packages in this document) is that random effects must be described with Normal distribution, even though it is technically possible to fit models in Stan with non-Normal random effects. The generated code may also not be the most optimal.</p>
<p>The package offers a single function <code>brm</code> with a very flexible formula system (it is also useful to know the function <code>bf</code> to specify more complex formula).</p>
</section>
</section>
<section id="linear-responses" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Linear responses</h1>
<p>Models with linear responses are those where parameters are linear with respect to the response variables. This does not mean that the response is linear, it can also be a polynomial (by taking integer powers of covariates) but the parameters are always linear with respect to the response variables. Historically the analysis of linear models has split into two approaches:</p>
<ul>
<li><p>Linear regression: When predictors are continuous, focuses on estimating parameter values.</p></li>
<li><p>Analysis of variance: When predictors are discrete, focuses on comparing nested models via F-test.</p></li>
</ul>
<p>And there were several sub-types such as multiple linear regression, analysis of covariance (with both discrete and continuous predictors), etc. In the examples below I only show how to estimate parameters of linear models.</p>
<section id="linear-model" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="linear-model"><span class="header-section-number">4.1</span> Linear model</h2>
<p>Stochastic model: A single level assumed Normal. Mean response: Linear function of covariates. Variance response: Assumed constant.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>Base</code></td>
<td><code>lm</code></td>
</tr>
<tr class="even">
<td>Likelihood</td>
<td><code>bbmle</code></td>
<td><code>mle2</code></td>
</tr>
<tr class="odd">
<td>Both</td>
<td><code>glmmTMB</code></td>
<td><code>glmmTMB</code></td>
</tr>
<tr class="even">
<td>Bayesian</td>
<td><code>rstanarm</code></td>
<td><code>stan_lm</code></td>
</tr>
<tr class="odd">
<td>Bayesian</td>
<td><code>brms</code></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p><strong>Example withe categorical predictor</strong></p>
<p>A linear model with a categorical predictor with 3 levels.</p>
<p>Data simulation:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>sd  <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>deltas <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="fl">1.5</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>mus <span class="ot">=</span> <span class="fu">c</span>(mu0, mu0 <span class="sc">+</span> deltas)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>n   <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>groups <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>L<span class="sc">:</span><span class="dv">3</span>L, <span class="at">each =</span> n)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">3</span><span class="sc">*</span>n, <span class="fu">rep</span>(mus, <span class="at">each =</span> n), <span class="at">sd =</span> sd)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">groups =</span> groups, <span class="at">fgroups =</span> <span class="fu">as.factor</span>(groups))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Explicit maximum likelihood:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(mu0, delta1, delta2, lsd, groups, y) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  mus <span class="ot">=</span> <span class="fu">c</span>(mu0, mu0 <span class="sc">+</span> delta1, mu0 <span class="sc">+</span> delta2)[groups]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> mus, <span class="at">sd =</span> <span class="fu">exp</span>(lsd), <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mle2</span>(<span class="at">minuslogl =</span> NLL, <span class="at">start =</span> <span class="fu">list</span>(<span class="at">mu0 =</span> <span class="dv">1</span>, <span class="at">delta1 =</span> <span class="dv">0</span>, <span class="at">delta2 =</span> <span class="dv">0</span>, <span class="at">lsd =</span> <span class="fu">log</span>(<span class="dv">1</span>)),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>lm</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>fgroups, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>mle</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mle</span>(y<span class="sc">~</span>fgroups, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>mle2</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mle2</span>(y<span class="sc">~</span><span class="fu">dnorm</span>(<span class="at">mean =</span> mu, <span class="at">sd =</span> sd), <span class="at">parameters =</span> <span class="fu">list</span>(mu <span class="sc">~</span> fgroups),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">start =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>glmmTMB</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glmmTMB</span>(y<span class="sc">~</span>fgroups, <span class="at">family =</span> <span class="fu">gaussian</span>(), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>rstanarm</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_lm</span>(y<span class="sc">~</span>fgroups, <span class="at">data =</span> data, <span class="at">prior =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brm</code></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(y<span class="sc">~</span>fgroups, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">gaussian</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Example with continuous predictor</strong></p>
<p>A simple linear regression.</p>
<p>Data simulation:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>a   <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>b   <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>sd  <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>n   <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>x   <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="dv">5</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, a <span class="sc">+</span> b<span class="sc">*</span>x, <span class="at">sd =</span> sd)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Negative log-likelihood:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(mu1, mu2, mu3, sd, groups, y) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  mus <span class="ot">=</span> <span class="fu">c</span>(mu1, mu2, mu3)[groups]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> mus, <span class="at">sd =</span> sd, <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>lm</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y<span class="sc">~</span>fgroups, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>mle2</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mle2</span>(y<span class="sc">~</span><span class="fu">dnorm</span>(<span class="at">mean =</span> mu, <span class="at">sd =</span> sd), <span class="at">parameters =</span> <span class="fu">list</span>(mu <span class="sc">~</span> fgroups),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">start =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>glmmTMB</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glmmTMB</span>(y<span class="sc">~</span>fgroups, <span class="at">family =</span> <span class="fu">gaussian</span>(), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>rstanarm</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_lm</span>(y<span class="sc">~</span>fgroups, <span class="at">data =</span> data, <span class="at">prior =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brm</code></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(y<span class="sc">~</span>fgroups, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">gaussian</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="generalized-least-squares" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="generalized-least-squares"><span class="header-section-number">4.2</span> Generalized least squares</h2>
<p>Stochastic model: A single level assumed Normal. Mean response: Linear function of covariates. Variance response: Non-linear function of covariates and/or correlation structure.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>nlme</code></td>
<td><code>gls</code></td>
</tr>
<tr class="even">
<td>Likelihood</td>
<td><code>stats4</code></td>
<td><code>mle</code></td>
</tr>
<tr class="odd">
<td>Likelihood</td>
<td><code>bbmme</code></td>
<td><code>mle2</code></td>
</tr>
<tr class="even">
<td>Bayesian</td>
<td><code>brms</code></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p><strong>Examples</strong></p>
<p>A linear model with variance increasing exponentially with covariate.</p>
<p>Data simulation:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>a   <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>b   <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>c   <span class="ot">=</span> <span class="fl">0.05</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>n   <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>x   <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="dv">5</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, a <span class="sc">+</span> b<span class="sc">*</span>x, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(<span class="dv">2</span><span class="sc">*</span>c<span class="sc">*</span>x)))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Negative log-likelihood:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, b, c, x, y) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  mus <span class="ot">=</span> a <span class="sc">+</span> b<span class="sc">*</span>x</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  sd  <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(<span class="dv">2</span><span class="sc">*</span>c<span class="sc">*</span>x))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> mus, <span class="at">sd =</span> sd, <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>gls</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">gls</span>(y<span class="sc">~</span>x, <span class="at">weights =</span> <span class="fu">varExp</span>(<span class="at">form =</span> <span class="sc">~</span>x), <span class="at">data =</span> data, <span class="at">method =</span> <span class="st">"ML"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>mle2</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mle2</span>(y<span class="sc">~</span><span class="fu">dnorm</span>(<span class="at">mean =</span> a <span class="sc">+</span> b<span class="sc">*</span>x, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="fu">exp</span>(<span class="dv">2</span><span class="sc">*</span>c<span class="sc">*</span>x))),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">start =</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">c =</span> <span class="fl">0.05</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brm</code>. Note that we have two switch to a non-linear because we are using an exponential function for <code>sigma</code>. This also means we should specify some priors as <code>brms</code> will not provide reasonable priors for non-linear models:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(<span class="fu">bf</span>(y<span class="sc">~</span>a <span class="sc">+</span> b<span class="sc">*</span>x,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">nlf</span>(sigma<span class="sc">~</span><span class="fu">sqrt</span>(<span class="fu">exp</span>(<span class="dv">2</span><span class="sc">*</span>c<span class="sc">*</span>x))),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>       a <span class="sc">+</span> b <span class="sc">+</span> c <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">nl =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="st">"normal(0,1)"</span>, <span class="at">class =</span> <span class="st">"b"</span>, <span class="at">nlpar =</span> <span class="st">"a"</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">prior</span>(<span class="st">"normal(0,1)"</span>, <span class="at">class =</span> <span class="st">"b"</span>, <span class="at">nlpar =</span> <span class="st">"b"</span>),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">prior</span>(<span class="st">"normal(0,1)"</span>, <span class="at">class =</span> <span class="st">"b"</span>, <span class="at">nlpar =</span> <span class="st">"c"</span>)),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">gaussian</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="linear-mixed-model" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="linear-mixed-model"><span class="header-section-number">4.3</span> Linear mixed model</h2>
<p>Stochastic model: Multiple levels assumed Normal. Mean response: Linear function of covariates. Variance response: Non-linear function of covariates and/or correlation structure.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>nlme</code></td>
<td><code>lme</code></td>
</tr>
<tr class="even">
<td>Likelihood</td>
<td><code>lme4</code></td>
<td><code>lmer</code></td>
</tr>
<tr class="odd">
<td>Both</td>
<td><code>glmmTMB</code></td>
<td><code>glmmTMB</code></td>
</tr>
<tr class="even">
<td>Bayesian</td>
<td><code>rstanarm</code></td>
<td><code>stan_lmer</code></td>
</tr>
<tr class="odd">
<td>Bayesian</td>
<td><code>brms</code></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p>Note that <code>lmer</code> and <code>stan_lmer</code> allow for some correlation structure in residuals but do not allow modelling the variance itself. For that you need to use <code>lme</code> or <code>brm</code>.</p>
<p><strong>Examples</strong></p>
<p>A linear model with with random intercepts.</p>
<p>Data simulation:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>Int <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>groups <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>ranef <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>Int_group <span class="ot">=</span> Int <span class="sc">+</span> ranef</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>b   <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>n   <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>x   <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="dv">5</span>), <span class="at">times =</span> <span class="dv">10</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>Int_group_ex <span class="ot">=</span> <span class="fu">rep</span>(Int_group, <span class="at">each =</span> <span class="dv">50</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, Int_group_ex <span class="sc">+</span> b<span class="sc">*</span>x, <span class="at">sd =</span> sigma)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">group =</span> <span class="fu">rep</span>(groups, <span class="at">each =</span> <span class="dv">50</span>))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, <span class="at">col =</span> <span class="fu">as.factor</span>(group), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The joint Negative log-likelihood:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, b, sigma, sigma_group, ranef, x, y, group) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>   as <span class="ot">=</span> (a <span class="sc">+</span> ranef)[group]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> as <span class="sc">+</span> b<span class="sc">*</span>x, <span class="at">sd =</span> sigma, <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">-</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sum</span>(<span class="fu">dnorm</span>(ranef, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we treat <code>ranef</code> as latent random varaibles this joint NLL cannot be solved directly by maximum likelihood but instead we would need to marginalize over the distribution of <code>ranef</code> (as in chapter 10).</p>
<p>With <code>lme</code></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lme</span>(y<span class="sc">~</span>x, <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> group, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>lmer</code></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lmer</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>glmmTMB</code></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glmmTMB</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>stan_lmer</code></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_lmer</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brm</code></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="non-linear-responses" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Non-linear responses</h1>
<p>Models where the mean is modeled by a non-linear function of covariates.</p>
<p>Canned only support non-linear models that can be expressed as a formula so they must be quite simple. In Likelihood versions, it is important to choose good initial values as otherwise the algorithms will not converge. For that reason it is common to use self-starting functions that already specify a model and an internal algorithm to come up with good starting values (these are compatible with <code>nls</code> and <code>gnls</code>.</p>
<section id="on-self-starting-functions" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="on-self-starting-functions"><span class="header-section-number">5.1</span> On self-starting functions</h2>
<p>For non-linear models it is very important to have good initial estimates of parameters. R has the concept of <em>self-starting</em> models. A self-starting model implements a particular model and a procedure to â€œeye-ballâ€ the initial values:</p>
<ul>
<li><p>Package <code>stats</code> provides <code>SSasymp</code>, <code>SSasympOff</code>, <code>SSasympOrig</code>, <code>SSbiexp</code>, <code>SSfol</code>, <code>SSfpl</code>, <code>SSgompertz</code>, <code>SSlogis</code>, <code>SSmicmen</code>, <code>SSweibull</code></p></li>
<li><p>The package <code>nlraa</code> provides 28 new self-starting functions that are used in agricultural research but could be useful in more general ecological applications.</p></li>
<li><p>The package <code>vega</code> provides 4 new self-starting functions to model the relationship between species richness and area</p></li>
</ul>
<p>See this blog post on how to write your own self-starting functions: https://www.statforbiology.com/2020/stat_nls_selfstarting/</p>
</section>
<section id="non-linear-model" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="non-linear-model"><span class="header-section-number">5.2</span> Non-linear model</h2>
<p>Stochastic model: A single level, assumed Normal. Mean response: Non-linear function of covariates. Variance response: Assumed constant (but see note).</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>Base</code></td>
<td><code>nls</code></td>
</tr>
<tr class="even">
<td>Likelihood</td>
<td><code>nlme</code><sup>1,2</sup></td>
<td><code>gnls</code></td>
</tr>
<tr class="odd">
<td>Likelihood</td>
<td><code>stats4</code></td>
<td><code>mle</code></td>
</tr>
<tr class="even">
<td>Likelihood</td>
<td><code>bbmle</code><sup>2</sup></td>
<td><code>mle2</code></td>
</tr>
<tr class="odd">
<td>Bayesian</td>
<td><code>brms</code><sup>1,2</sup></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p><sup>1</sup> Correlation structure for residuals <sup>2</sup> Variance can be modeled as a non-linear function of covariates.</p>
<p><strong>Example</strong></p>
<p>A Michaelis-Menten model:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>sd  <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>a   <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>b   <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>x   <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="at">mean =</span> a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x), <span class="at">sd =</span> sd)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The negative log-likelihood would be:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, b, sigma, y, x) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma, <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>nls</code></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">nls</span>(y<span class="sc">~</span>a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="dv">5</span>, <span class="at">b =</span> <span class="dv">2</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>mle2</code></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">mle2</span>(y<span class="sc">~</span><span class="fu">dnorm</span>(<span class="at">mean =</span> a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x), <span class="at">sd =</span> sd), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="dv">5</span>, <span class="at">b =</span> <span class="dv">2</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brm</code> (for non linear models we should always give priors and bounds):</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(<span class="fu">bf</span>(y<span class="sc">~</span>a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x), a <span class="sc">~</span> <span class="dv">1</span>, b <span class="sc">~</span> <span class="dv">1</span>, <span class="at">nl =</span> <span class="cn">TRUE</span>), <span class="at">data =</span> data,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">set_prior</span>(<span class="st">"normal(10,10)"</span>, <span class="at">nlpar =</span> <span class="st">"a"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">set_prior</span>(<span class="st">"normal(3,3)"</span>,  <span class="at">nlpar =</span> <span class="st">"b"</span>, <span class="at">lb =</span> <span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="non-linear-mixed-models" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="non-linear-mixed-models"><span class="header-section-number">5.3</span> Non-linear mixed models</h2>
<p>Stochastic model: Multiple levels assumed Normal. Mean response: Linear function of covariates after link transformation. Variance response: Correlation structure for residuals and variance can be modeled as non-linear function of covariates.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>nlme</code></td>
<td><code>nlme</code></td>
</tr>
<tr class="even">
<td>Bayesian</td>
<td><code>brms</code></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p><strong>Example</strong></p>
<p>A Michaelis-Menten model:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>sd  <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>a   <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>groups <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>ranef <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>as <span class="ot">=</span> a <span class="sc">+</span> <span class="fu">rep</span>(ranef, <span class="at">each =</span> <span class="dv">10</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>b   <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>x   <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">times =</span> <span class="dv">10</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10</span><span class="sc">*</span><span class="dv">10</span>, <span class="at">mean =</span> as<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x), <span class="at">sd =</span> sd)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">group =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(groups, <span class="at">each =</span> <span class="dv">10</span>)))</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, <span class="at">col =</span> group, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The joint negative log-likelihood would be:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, b, sigma, sigma_group, ranef, y, x) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  as <span class="ot">=</span> (a <span class="sc">+</span> ranef)[group]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> as<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnorm</span>(y, <span class="at">mean =</span> mu, <span class="at">sd =</span> sigma, <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">-</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sum</span>(<span class="fu">dnorm</span>(ranef, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>nlme</code> using self-starting function <code>micmen</code>:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlme</span>(y<span class="sc">~</span><span class="fu">SSmicmen</span>(x, a, b),</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">fixed =</span> a <span class="sc">+</span> b <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">random =</span> a <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> group,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">start =</span> <span class="fu">c</span>(<span class="at">a =</span> <span class="dv">10</span>, <span class="at">b =</span> <span class="dv">1</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with <code>nlmer</code> (notice that we do not add the random effect on <code>a</code> but rather use a second <code>~</code>)</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nlmer</span>(y<span class="sc">~</span><span class="fu">SSmicmen</span>(x, a, b) <span class="sc">~</span> a<span class="sc">|</span>group,</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> data, <span class="at">start =</span> <span class="fu">c</span>(<span class="at">a =</span> <span class="dv">10</span>, <span class="at">b =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>stan_nlmer</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_nlmer</span>(y<span class="sc">~</span><span class="fu">SSmicmen</span>(x, a, b) <span class="sc">~</span> a<span class="sc">|</span>group, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brms</code> (it is very important to set the bounds on parameters):</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">brm</span>(<span class="fu">bf</span>(y<span class="sc">~</span>a<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x), b <span class="sc">~</span> <span class="dv">1</span>, a <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> group, <span class="at">nl =</span> <span class="cn">TRUE</span>), <span class="at">data =</span> data,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">set_prior</span>(<span class="st">"normal(10,2)"</span>, <span class="at">nlpar =</span> <span class="st">"a"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">set_prior</span>(<span class="st">"normal(1,1)"</span>,  <span class="at">nlpar =</span> <span class="st">"b"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">set_prior</span>(<span class="st">"normal(0,2)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">nlpar =</span> <span class="st">"a"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">set_prior</span>(<span class="st">"normal(0,1)"</span>, <span class="at">class =</span> <span class="st">"sigma"</span>, <span class="at">lb =</span> <span class="dv">0</span>)))</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="generalized-linear-responses" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Generalized linear responses</h1>
<p>Models where the response variable is assumed different from Normal. The mean is modeled by a non-linear function (link) and a linear model of covariates. In other words, these models are non-linear but the parameters reported are linear with respect to a transformation of the mean.</p>
<p>Canned methods generally support a number of pre-specified distributions and link functions. For more diversity you will have to write you own model.</p>
<section id="generalized-linear-models" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="generalized-linear-models"><span class="header-section-number">6.1</span> Generalized linear models</h2>
<p>Stochastic model: A single level of one of the pre-specified distributions. Mean response: Linear function of covariates after link transformation. Variance response: Scale parameter (if present) assumed constant (but see note).</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>Base</code></td>
<td><code>glm</code></td>
</tr>
<tr class="even">
<td>Both</td>
<td><code>glmmTMB</code><sup>1</sup></td>
<td><code>glmmTMB</code></td>
</tr>
<tr class="odd">
<td>Bayesian</td>
<td><code>stanarm</code></td>
<td><code>stan_glm</code></td>
</tr>
<tr class="even">
<td>Bayesian</td>
<td><code>brms</code><sup>1,2</sup></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p><sup>1</sup> Correlation structure for residuals <sup>2</sup> Scale parameter can be modeled as non-linear function of covariates.</p>
<p><strong>Example</strong></p>
<p>A Poisson model with an log link function</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>a   <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>b   <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>x   <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">times =</span> <span class="dv">5</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rpois</span>(<span class="dv">50</span>, <span class="at">lambda =</span> <span class="fu">exp</span>(a <span class="sc">+</span> b<span class="sc">*</span>x))</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The negative log-likelihood:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, b, y, x) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  log_mu <span class="ot">=</span> a <span class="sc">+</span> b<span class="sc">*</span>x</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(y, <span class="at">lambda =</span> <span class="fu">exp</span>(log_mu), <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>glm</code></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(y<span class="sc">~</span>x, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>glmmTMB</code></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glmmTMB</span>(y<span class="sc">~</span>x, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>stanarm</code></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_glm</span>(y<span class="sc">~</span>x, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brms</code></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(y<span class="sc">~</span>x, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="generalized-linear-mixed-models" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="generalized-linear-mixed-models"><span class="header-section-number">6.2</span> Generalized linear mixed models</h2>
<p>Stochastic model: Multiple levels. The latent ones must be Normal. Mean response: Linear function of covariates after link transformation. Variance response: In some cases in can be modeled as a function of covariates.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>lme4</code></td>
<td><code>glmer</code></td>
</tr>
<tr class="even">
<td>Both</td>
<td><code>glmmTMB</code><sup>1</sup></td>
<td><code>glmmTMB</code></td>
</tr>
<tr class="odd">
<td>Bayesian</td>
<td><code>stanarm</code></td>
<td><code>stan_glmer</code></td>
</tr>
<tr class="even">
<td>Bayesian</td>
<td><code>brms</code><sup>1,2</sup></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p><sup>1</sup> Correlation structure for residuals <sup>2</sup> Scale parameter can be modeled as non-linear function of covariates.</p>
<p><strong>Example</strong></p>
<p>A Poisson model with a log link function</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>a   <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>ranef <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>group <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>as  <span class="ot">=</span> <span class="fu">rep</span>(a <span class="sc">+</span> ranef, <span class="at">each =</span> <span class="dv">50</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>b   <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>x   <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">times =</span> <span class="dv">50</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">=</span> <span class="fu">rpois</span>(<span class="dv">500</span>, <span class="at">lambda =</span> <span class="fu">exp</span>(as <span class="sc">+</span> b<span class="sc">*</span>x))</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">group =</span> <span class="fu">rep</span>(group, <span class="at">each =</span> <span class="dv">50</span>))</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, <span class="at">col =</span> group, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The joint negative log-likelihood:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, b, sigma_group, ranef, group, y, x) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  as <span class="ot">=</span> (a <span class="sc">+</span> ranef)[group]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  log_mu <span class="ot">=</span> as<span class="sc">*</span>x<span class="sc">/</span>(b <span class="sc">+</span> x)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(y, <span class="at">lambda =</span> <span class="fu">exp</span>(log_mu), <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">-</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sum</span>(<span class="fu">dnorm</span>(ranef, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>glmer</code></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glmer</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>glmmTMB</code></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glmmTMB</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>stan_glmer</code></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_glmer</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brm</code></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(y<span class="sc">~</span>x <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="generalized-non-linear-responses" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Generalized non-linear responses</h1>
<section id="generalized-non-linear-models" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="generalized-non-linear-models"><span class="header-section-number">7.1</span> Generalized non-linear models</h2>
<p>Stochastic model: A single level of one of the pre-specified distributions. Mean response: Non-linear function of covariates. Variance response: Variance can be modeled as non-linear function of covariates.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Likelihood</td>
<td><code>stats4</code></td>
<td><code>mle</code></td>
</tr>
<tr class="even">
<td>Likelihood</td>
<td><code>bbmle</code></td>
<td><code>mle2</code></td>
</tr>
<tr class="odd">
<td>Bayesian</td>
<td><code>brms</code><sup>1</sup></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p><sup>1</sup> Also allows correlation structures</p>
<p><strong>Example</strong></p>
<p>A power law with a negative binomial (like the cone production example in the book).</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="dv">5</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rnbinom</span>(<span class="dv">50</span>, <span class="at">mu =</span> a<span class="sc">*</span>x<span class="sc">^</span>b, <span class="at">size =</span> k)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The negative log-likelihood would be:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, b, k, y, x) {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> a<span class="sc">*</span>x<span class="sc">^</span>b</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnbinom</span>(y, <span class="at">mu =</span> mu, <span class="at">size =</span> k, <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>mle2</code>:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mle2</span>(y<span class="sc">~</span><span class="fu">dnbinom</span>(<span class="at">mu =</span> a<span class="sc">*</span>x<span class="sc">^</span>b, <span class="at">size =</span> k), <span class="at">start =</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="fl">0.5</span>, <span class="at">b =</span> <span class="dv">2</span>, <span class="at">k =</span> <span class="dv">10</span>),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">c</span>(<span class="at">a =</span> <span class="fl">0.01</span>, <span class="at">b =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span>), <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>, <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brms</code>:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(<span class="fu">bf</span>(y<span class="sc">~</span>a<span class="sc">*</span>x<span class="sc">^</span>b, a<span class="sc">~</span><span class="dv">1</span>, b <span class="sc">~</span> <span class="dv">1</span>, <span class="at">nl =</span> <span class="cn">TRUE</span>),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">family =</span> <span class="fu">negbinomial</span>(<span class="at">link =</span> <span class="st">"identity"</span>, <span class="at">link_shape =</span> <span class="st">"identity"</span>),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="st">"normal(2,2)"</span>, <span class="at">nlpar =</span> <span class="st">"b"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">prior</span>(<span class="st">"normal(2,2)"</span>, <span class="at">nlpar =</span> <span class="st">"a"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">prior</span>(<span class="st">"normal(10,10)"</span>, <span class="at">class =</span> <span class="st">"shape"</span>, <span class="at">lb =</span> <span class="dv">0</span>)),</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">data =</span> data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="generalized-non-linear-mixed-models" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="generalized-non-linear-mixed-models"><span class="header-section-number">7.2</span> Generalized non-linear mixed models</h2>
<p>Stochastic model: Multiple levels. The latent ones must be Normal. Mean response: Non-linear function of covariates. Variance response: Correlation structure for residuals and variance can be modeled as non-linear function of covariates.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Paradigm</th>
<th>Package</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Bayesian</td>
<td><code>brms</code></td>
<td><code>brm</code></td>
</tr>
</tbody>
</table>
<p>A power law with a negative binomial where the power coefficient varies across groups (we use link function to enforce positivity as brms only accepts Gaussian random effects).</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>lb <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">2</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>ranef <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="fl">0.3</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>group <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>bs <span class="ot">=</span> <span class="fu">exp</span>(lb <span class="sc">+</span> ranef)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="dv">5</span>), <span class="at">times =</span> <span class="dv">10</span>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>bs_ext <span class="ot">=</span> <span class="fu">rep</span>(bs, <span class="at">each =</span> <span class="dv">50</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rnbinom</span>(<span class="dv">500</span>, <span class="at">mu =</span> a<span class="sc">*</span>x<span class="sc">^</span>bs_ext, <span class="at">size =</span> k)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">group =</span> <span class="fu">rep</span>(group, <span class="at">each =</span> <span class="dv">50</span>))</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y<span class="sc">~</span>x, <span class="at">data =</span> data, <span class="at">col =</span> <span class="fu">as.factor</span>(group))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The joint negative log-likelihood would be:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>NLL <span class="ot">=</span> <span class="cf">function</span>(a, lb, k, sigma_group, ranef, group, y, x) {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  bs <span class="ot">=</span> <span class="fu">exp</span>((lb <span class="sc">+</span> ranef)[group])</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> a<span class="sc">*</span>x<span class="sc">^</span>bs</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dnbinom</span>(y, <span class="at">mu =</span> mu, <span class="at">k =</span> k, <span class="at">log =</span> <span class="cn">TRUE</span>)) <span class="sc">-</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sum</span>(<span class="fu">dnorm</span>(ranef, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma_group, <span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>brms</code> (this will take a while to run):</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">brm</span>(<span class="fu">bf</span>(y<span class="sc">~</span>a<span class="sc">*</span>x<span class="sc">^</span><span class="fu">exp</span>(lb), a <span class="sc">~</span> <span class="dv">1</span>, lb <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> group), <span class="at">nl =</span> <span class="cn">TRUE</span>), <span class="at">data =</span> data,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">negbinomial</span>(<span class="at">link =</span> <span class="st">"identity"</span>, <span class="at">link_shape =</span> <span class="st">"identity"</span>),</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="st">"normal(1,1)"</span>, <span class="at">class =</span> <span class="st">"b"</span>, <span class="at">nlpar =</span> <span class="st">"lb"</span>),</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="st">"normal(1,1)"</span>, <span class="at">nlpar =</span> <span class="st">"a"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="st">"normal(1,1)"</span>, <span class="at">class =</span> <span class="st">"sd"</span>, <span class="at">nlpar =</span> <span class="st">"lb"</span>, <span class="at">lb =</span> <span class="dv">0</span>),</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="st">"normal(10,10)"</span>, <span class="at">class =</span> <span class="st">"shape"</span>, <span class="at">lb =</span> <span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/AleMorales\.github\.io\/EcologicalModelsLabs\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>